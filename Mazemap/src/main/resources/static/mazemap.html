<!DOCTYPE html>
<head>
<meta name="viewport" id="vp"
	content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width" />
<meta charset="utf-8" />


<link rel="stylesheet"
	href="https://api.mazemap.com/js/v2.0.14/mazemap.min.css">
	<script type='text/javascript' src='https://api.mazemap.com/js/v2.0.14/mazemap.min.js'></script>
	<script src="./js/jquery.min.js"></script>
	<script src="./js/jquery.poptrox.min.js"></script>
	<script src="./js/jquery.scrolly.min.js"></script>
	<script src="./js/skel.min.js"></script>
	<script src="./js/util.js"></script>
	<script src="./js/main.js"></script>
	<script src="./kendo-ui-core/js/kendo.core.min.js"></script>
<style>
body {
	margin: 0px;
	padding: 0px;
	width: 100%;
	height: 100%;
	
}
#sensorZones{
            position: absolute;
            box-sizing: border-box;
            padding: 10px;
            top: 80px;
            left: 10px;
            width: auto;
            height: auto;
            width: calc( 50% - 20px );
            display: none;
            background: rgb(255, 255, 255);
            border-radius: 4px;
            box-shadow: 0px 0px 0px 1px rgba(93, 93, 93, 0.31)
        }
#createButton{
 			position: absolute;
            box-sizing: border-box;
            padding: 10px;
            top: 10px;
            left: 10px;
            width: auto;
            height: auto;
            display: block;
            background: rgb(255, 255, 255);
            border-radius: 4px;
            box-shadow: 0px 0px 0px 1px rgba(93, 93, 93, 0.31)           
}
#okPlacement{
 			position: absolute;
            box-sizing: border-box;
            padding: 10px;
            top: 10px;
            left: 10px;
            width: auto;
            height: auto;
            display: none;
            background: rgb(255, 255, 255);
            border-radius: 4px;
            box-shadow: 0px 0px 0px 1px rgba(93, 93, 93, 0.31)           
}        
#bg-modal{
			position: absolute;
            box-sizing: border-box;
            padding: 10px;
            top: 10px;
            left: 10px;
            width: auto;
            height: auto;
            display: none;
            background: rgb(255, 255, 255);
}
#feedback{
position: absolute;
            box-sizing: border-box;
            padding: 10px;
            top: 10px;
            left: 120px;
            width: auto;
            height: auto;
            display: none;
            background: rgb(255, 255, 255);
}
</style>
</head>
<body>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery.poptrox.min.js"></script>
    <script src="/js/jquery.scrolly.min.js"></script>
    <script src="/js/skel.min.js"></script>
    <script src="/js/util.js"></script>
    <script src="/js/main.js"></script>
   
	<div id="startLat"></div>
	<div id="startLon"></div>
	<div id="map" class="mazemap"></div>
    <div id="sensorZones"></div>
    <button id="createButton" class="createButton">Create Event</button>
    <button id="okPlacement" class="okPlacement">Place Event</button>
    <section id="createEvent">
			<div class="feedback" id="feedback"></div>
			<!-- The popup modal -->
					<div class="bg-modal" id="bg-modal">
						<div class="modal-content">
							<div id="close" class="close">x</div>
							<form id="createEventForm">
								<input type="text" id="description" name="eventDescr" placeholder="Event Description">
								<input type="date" id="date" name="date" placeholder="Event date">
								<input type="text" id="name" name="name" placeholder="Event Name">
								<input type="time" id="time" name="time" placeholder="Event hour">
								<input type="number" step=0.0000000000000001 id="eventLng" class="eventLng" name="lng" placeholder="Event Longitude">
								<input type="number" step=0.0000000000000001 id="eventLat" class="eventLat" name="lat" placeholder="Event Latitude">
								<button type="button" id="placeEvent" class="placeEvent" name="placeEvent">Place Event</button>
								<button type="submit" id="submitEventForm" onclick="fire_ajax_submit()">Create Event</button>
							</form>
						</div>
					</div>
			</section>
			
	<script>
	
	document.getElementById("createButton").addEventListener("click", function() {
		document.querySelector(".bg-modal").style.display="block";
		document.querySelector(".feedback").style.display="none";
	});
	
	document.getElementById("close").addEventListener("click", function() {
		document.querySelector(".bg-modal").style.display="none";
		document.querySelector(".createButton").style.display="block";
		if(placingEvent){
			createMarker.remove();
		}
	});
	
    	var currentLat,currentLong;
        var map = new Mazemap.Map({
            // container id specified in the HTML
            container: 'map',

            campuses: 89,

            // initial position in lngLat format
            
            center: {lng: 12.521545, lat: 55.785585},

            // initial zoom
            zoom: 15,

            zLevel: 1
        });
       
        // Add zoom and rotation controls to the map.
        map.addControl(new Mazemap.mapboxgl.NavigationControl());
		var zonePolygons;
		var lngLat = {lng: 12.525542, lat: 55.786158}; // DTU Library
		
		window.onload = function() {
			
		// check for Geolocation support
		if (navigator.geolocation) {
			console.log('Geolocation is supported!');
		}
		else {
			console.log('Geolocation is not supported for this Browser/OS.');
		}

		  	var startPos;
		  	var geoOptions = {
			    enableHighAccuracy: true
			}
		  	var geoSuccess = function(position) {
		  		startPos = position;
		    	document.getElementById('startLat').innerHTML = startPos.coords.latitude;
		    	document.getElementById('startLon').innerHTML = startPos.coords.longitude;
		    	currentLat = startPos.coords.latitude;
		    	currentLong = startPos.coords.longitude;
			};
			navigator.geolocation.getCurrentPosition(geoSuccess);
		};
		
		//map.center = {lng: currentLong, lat: currentLat};
		  map.on('load', function(){
			  
			  console.log(currentLong,currentLat);
		
		var blueDot = new Mazemap.BlueDot( {
		   	zLevel: 1,
		   	accuracyCircle: true
			} )
			.setLngLat( {lng: currentLong, lat: currentLat} )
			.setAccuracy(10).addTo(map);
		/**
 		* Kasper Jensen s183051
 		*
 		* Layers, get request for zones
 		*/
 		
		map.addLayer({
			      id: 'custom-polygon-layer',
		          type: "fill",
		          source: {
		    	      type: 'geojson',
		              data: null,
		          },
		          paint: {
		              "fill-color": "#fc0",
		              "fill-outline-color": "red"
		          }
		      });			 
		map.layerEventHandler.on('click', 'custom-polygon-layer', (e, features) => {    
           	var output = ""
           	var zonePropertiesArray = JSON.parse(features[0].properties.zoneProperties);
           	for(var i in zonePropertiesArray)
           		output = appendString(zonePropertiesArray[i], output);
                	
           	document.getElementById("sensorZones").style.display = "flex";
           	document.getElementById("sensorZones").innerHTML = output; 
        });		
            
		map.on('zlevel', redrawPolygons);
	    redrawPolygons();
	    
	    
	    //fetching events on window load
	    redrawMarkers();
	    	         
		  });
			  
	//simple append function
	function appendString(item, output) {
		var res = output.concat(item.type + ": " + item.value + " " + item.unit + " ");
		return res;
	}
	
	var center = map.getBounds().getCenter();
 	document.querySelector(".eventLng").value=center.lng;
 	document.querySelector(".eventLat").value=center.lat;
     
 
 	var placingEvent = false;
 	map.on('drag', function() {
 		center = map.getBounds().getCenter();
     	document.querySelector(".eventLng").value=center.lng;
     	document.querySelector(".eventLat").value=center.lat;
     	if(placingEvent){
     		createMarker.setLngLat({lng: center.lng, lat: center.lat});
     	}
		});
	
 
 	
	function fire_ajax_submit() {

	    var event = {}
	    event["description"] = $("#description").val();
	    event["name"] = $("#name").val();
	    event["date"] = $("#date").val();
	    event["time"] = $("#time").val();
	    event["lng"] = $("#eventLng").val();
	    event["lat"] = $("#eventLat").val();
	    

	    $("#submitEventForm").prop("disabled", true);

	    $.ajax({
	        type: "POST",
	        contentType: "application/json",
	        url: "/events/createevent",
	        data: JSON.stringify(event),
	        dataType: 'json',
	        cache: false,
	        timeout: 600000,
	        success: function (data) {

	            var json = "<h4>Ajax Response</h4><pre>"
	                + JSON.stringify(data, null, 4) + "</pre>";
	            $('#feedback').html(data.msg);
	            window.location.reload(true);
	            console.log("SUCCESS : ", data);
	            $("#submitEventForm").prop("disabled", false);
	            document.querySelector(".feedback").style.display="block";
	            document.querySelector(".bg-modal").style.display="none";

	        },
	        error: function (e) {

	            var json = "<h4>Ajax Response</h4><pre>"
	                + e.responseText + "</pre>";
	            $('#feedback').html(json);
	            document.querySelector(".feedback").style.display="block";
	            document.querySelector(".bg-modal").style.display="none";
	            console.log("ERROR : ", e);
	            $("#submitEventForm").prop("disabled", false);

	        }
	    });

	}	
	var createMarker;
	document.getElementById("placeEvent").addEventListener("click", function() {
		placingEvent = true;
 		center = map.getBounds().getCenter();
 		if(typeof(createMarker) === 'undefined')
 			{
		createMarker = new Mazemap.MazeMarker( {
			zLevel : 1,
			color: 'green',
			innerCircle: true,
			innerCircleColor: '#FEFEFE',
			innerCircleScale: 0.7,
			glyphColor: '#000',
			glyphSize: 20,
			glyph: 'ðŸ¤·'
		} ).setLngLat({lng: center.lng, lat: center.lat});
		 	createMarker.addTo(map);
 			}
		document.querySelector(".bg-modal").style.display="none";
		document.querySelector(".createButton").style.display="none";
		document.querySelector(".okPlacement").style.display="block";
		
	});
	
 	
	document.getElementById("okPlacement").addEventListener("click", function() {
 		document.querySelector(".bg-modal").style.display="block";
 		document.querySelector(".okPlacement").style.display="none";
 		
 	});
	
	//function to get and draw markers on the map - catching right now just to test
	function redrawMarkers() {   
		var eventData;
	    var markerIterator;
	    var markerIteratorPopup;
	    fetch('http://localhost:8080/events/eventdata').then(response => {
  			return response.json();
			}).then(data => {
  				eventData = data;
  				for(var i in eventData){
  			  		markerIterator = new Mazemap.MazeMarker( {
				zLevel : 1,
				color: 'green',
				innerCircle: true,
				innerCircleColor: '#FEFEFE',
				innerCircleScale: 0.7,
				glyphColor: '#000',
				glyphSize: 20,
				glyph: 'ðŸ¤·'
			} )
			.setLngLat({lng: eventData[i].lng, lat: eventData[i].lat})
			markerIteratorPopup = new Mazemap.Popup({ closeOnClick: true, offset: [0,-40]})
			.setHTML(eventData[i].date + " at " + eventData[i].time + " --- " + eventData[i].description);

			markerIterator.setPopup(markerIteratorPopup);
		
			markerIterator.addTo(map);
		
  		  	}                                    
		}).catch(err => {
			
  		         
	});
	}
				    
	//function to get and redraw polygons on start and on floor switch, Coordinates need to be server side
	function redrawPolygons() {
		var zLevel = map.getZLevel();
		if(zLevel > -1)
			zLevel = zLevel -1; 
		var getAddress = "http://localhost:8080/sensors/zonedata?level=".concat(zLevel);
	
		fetch(getAddress).then(response => {
  			return response.json();
			}).then(data => {
  				zonePolygons = data;
                map.getSource("custom-polygon-layer").setData({type: "FeatureCollection", features:zonePolygons });
				}).catch(err => {
  			console.log('The request failed!'); 
		});	         
	}
	
    </script>
  
    
</body>
